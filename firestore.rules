rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }
    function isAdmin() {
      return signedIn()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow update: if isOwner(uid)
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['expoPushTokens', 'updatedAt']);
    }

    match /notifications/{id} {
      allow read: if isAdmin()
        || (signedIn() && (
          resource.data.targetType == 'all'
          || (resource.data.targetType == 'users' && request.auth.uid in resource.data.targetUserIds)
        ));

      allow create, delete: if isAdmin();

      allow update: if isAdmin() || (
        signedIn()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['readBy'])
        && request.resource.data.readBy is list
        && resource.data.readBy is list
        && request.resource.data.readBy.hasAll(resource.data.readBy)
        && (
          request.resource.data.readBy.size() == resource.data.readBy.size()
          || (
            request.resource.data.readBy.size() == resource.data.readBy.size() + 1
            && request.auth.uid in request.resource.data.readBy
          )
        )
      );
    }
  }
}